From ca03cb6dc45b61f16e84bfef9e8a067a75281b62 Mon Sep 17 00:00:00 2001
From: firnsy <firnsy@securixlive.com>
Date: Tue, 28 Aug 2012 20:58:06 +1000
Subject: [PATCH 2/2] added: initial slides for windows and prevent reboot on
 shutdown for testing.

---
 anaconda                      | 12 +++++++----
 pyanaconda/iw/progress_gui.py | 49 +++++++++++++++++++++++++++++++++++--------
 2 files changed, 48 insertions(+), 13 deletions(-)

diff --git a/anaconda b/anaconda
index 939262d..cc00c85 100755
--- a/anaconda
+++ b/anaconda
@@ -71,13 +71,17 @@ def exitHandler(anaconda, exitCode=None):
                 dracut_eject(drive.path)
 
         if anaconda.ksdata.reboot.action == KS_SHUTDOWN:
-            os.system("systemctl --force --no-wall poweroff")
+            print("systemctl --force --no-wall poweroff")
+            #os.system("systemctl --force --no-wall poweroff")
         elif anaconda.ksdata.reboot.action == KS_WAIT:
-            os.system("systemctl --force --no-wall halt")
+            print("systemctl --force --no-wall halt")
+            #os.system("systemctl --force --no-wall halt")
         else: # reboot action is KS_REBOOT or None
-            os.system("systemctl --force --no-wall reboot")
+            print("systemctl --force --no-wall reboot")
+            #os.system("systemctl --force --no-wall reboot")
     elif not flags.imageInstall:
-        os.system("systemctl --force --no-wall reboot")
+        print("WOOT: systemctl --force --no-wall reboot")
+#        os.system("systemctl --force --no-wall reboot")
 
 def startMetacityWM():
     childpid = os.fork()
diff --git a/pyanaconda/iw/progress_gui.py b/pyanaconda/iw/progress_gui.py
index 516cc30..e3ab1d4 100644
--- a/pyanaconda/iw/progress_gui.py
+++ b/pyanaconda/iw/progress_gui.py
@@ -22,6 +22,7 @@ import os
 import glob
 
 import gtk
+import gobject
 import pango
 
 from pyanaconda import gui
@@ -44,13 +45,29 @@ class InstallProgressWindow (InstallWindow):
         self._updateChange = 0.01
         self._showPercentage = False
 
+        self._timerRnotes = None
+        self.pixmaps_index = 0
+
     def processEvents(self):
         gui.processEvents()
 
     def get_fraction(self):
         return self.progress.get_fraction()
+
     def set_fraction(self, pct):
         cur = self.get_fraction()
+
+        # if slideshow started, stop around 90%
+        if self._timerRnotes is not None:
+          if pct >= 0.99:
+            log.info('STOPPING Rotating release notes.')
+            gobject.source_remove(self._timerRnotes)
+            self._timerRnotes = None
+        # start slideshow (10s) if not started and above 0%
+        elif pct > 0:
+          self._timerRnotes = gobject.timeout_add(10000, self._rotateRnotes)
+          log.info('STARTING Rotating release notes.')
+
         if pct - cur > self._updateChange:
             self.progress.set_fraction(pct)
             if self._showPercentage:
@@ -85,27 +102,41 @@ class InstallProgressWindow (InstallWindow):
 
     def _getRnotes(self):
         langs = []
+        files = []
         pixmaps = []
         if (os.environ.has_key('LANG')):
             langs = localeinfo.expandLangs(os.environ['LANG'])
         langs.append('')
 
-        pixmaps = []
+        print langs
+
         paths = ("/tmp/product/pixmaps/rnotes/%s/*.png",
                  "/usr/share/anaconda/pixmaps/rnotes/%s/*.png")
         for p in paths:
             for lang in langs:
                 path = p % lang
-                pixmaps = glob.glob(path)
-                if len(pixmaps) > 0:
+                files = glob.glob(path)
+                if len(files) > 0:
                     break
 
-        if len(pixmaps) > 0:
-            files = pixmaps
-        else:
-            files = ["progress_first.png"]
+        files.sort();
+
+        return files;
+
+    def _rotateRnotes(self, _idx = -1):
+      if _idx >= 0 and _idx < len(self.pixmaps):
+        self.pixmaps_index = _idx
+      elif len(self.pixmaps) > 0:
+        self.pixmaps_index += 1
+        self.pixmaps_index %= len(self.pixmaps)
+
+        log.info('Rotating release notes. Slide %d (%d)' % (self.pixmaps_index, len(self.pixmaps)))
+        self.adpix.set_from_file( self.pixmaps[self.pixmaps_index] )
+        self.processEvents()
+
+
+      return True
 
-        return files
 
     def getScreen (self, anaconda):
         self.intf = anaconda.intf
@@ -140,7 +171,7 @@ class InstallProgressWindow (InstallWindow):
         vbox.pack_start(self.infolabel)
 
         # All done with creating components of UI
-        self.setPackageProgressWindow(self)
+        self.intf.setPackageProgressWindow(self)
         self.intf.setInstallProgressClass(self)
 
         vbox.set_border_width(6)
-- 
1.7.11.4

